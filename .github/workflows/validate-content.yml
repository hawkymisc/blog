name: Validate Content

on:
  push:
    branches:
      - 'update/**'
      - 'fix/**'
      - 'config/**'
    paths:
      - 'raws/**/*.md'
      - 'raws/**/*.qmd'
      - '_quarto.yml'
  pull_request:
    branches: [main]
    paths:
      - 'raws/**/*.md'
      - 'raws/**/*.qmd'
      - '_quarto.yml'

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: 'release'

      - name: Validate Quarto Rendering
        id: quarto_validate
        run: |
          echo "::group::Quarto Render Validation"
          quarto render raws/ --to html
          RESULT=$?
          echo "::endgroup::"

          if [ $RESULT -ne 0 ]; then
            echo "âŒ Quarto rendering failed"
            exit 1
          else
            echo "âœ… Quarto rendering successful"
          fi

      - name: Upload Preview Artifact
        uses: actions/upload-artifact@v4
        with:
          name: preview-site-${{ github.sha }}
          path: _site/
          retention-days: 7

      - name: Validation Summary
        if: always()
        run: |
          echo "## ðŸŽ¯ Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ ${{ steps.quarto_validate.outcome }} == "success" ]; then
            echo "- âœ… Quarto Rendering: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“¦ Preview artifact uploaded" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Ready to merge to main branch!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Quarto Rendering: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Please fix errors before merging.**" >> $GITHUB_STEP_SUMMARY
          fi
